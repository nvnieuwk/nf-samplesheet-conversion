nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"

    test("CSV") {

        when {
            params {
                input = "tests/inputs/samplesheet.csv"
            }
        }

        then {
            assert workflow.success
            assert workflow.stdout[0] ==~ '\\[\\[id:test, sample:test\\], .*/assets/test\\.cram, .*/assets/test\\.cram\\.crai, \\[\\]\\]'
            assert workflow.stdout[1] ==~ '\\[\\[id:test2, sample:test2\\], .*/assets/test\\.cram, \\[\\], .*/assets/test\\.bed\\]'
            assert workflow.trace.succeeded().size() == 2
        }

    }

    test("TSV") {

        when {
            params {
                input = "tests/inputs/samplesheet.tsv"
            }
        }

        then {
            assert workflow.success
            assert workflow.stdout[0] ==~ '\\[\\[id:test, sample:test\\], .*/assets/test\\.cram, .*/assets/test\\.cram\\.crai, \\[\\]\\]'
            assert workflow.stdout[1] ==~ '\\[\\[id:test2, sample:test2\\], .*/assets/test\\.cram, \\[\\], .*/assets/test\\.bed\\]'
            assert workflow.trace.succeeded().size() == 2
        }

    }

    test("Unknown extension") {

        when {
            params {
                input = "tests/inputs/samplesheet_tsv.txt"
            }
        }

        then {
            assert workflow.success
            assert workflow.stdout[0] ==~ '\\[\\[id:test, sample:test\\], .*/assets/test\\.cram, .*/assets/test\\.cram\\.crai, \\[\\]\\]'
            assert workflow.stdout[1] ==~ '\\[\\[id:test2, sample:test2\\], .*/assets/test\\.cram, \\[\\], .*/assets/test\\.bed\\]'
            assert workflow.trace.succeeded().size() == 2
        }

    }

    test("Unwanted Field") {

        when {
            params {
                input = "tests/inputs/unwanted_field.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] The samplesheet contains following unwanted field(s): [unwanted_field]")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Missing Field") {

        when {
            params {
                input = "tests/inputs/missing_field.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] The samplesheet must contain 'sample,cram,crai,bed' as header field(s), but is missing these: [bed]")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Non existing Field") {

        when {
            params {
                input = "tests/inputs/non_existing_field.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] Line 2 does not contain an input for field 'crai'.")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Empty required Field") {

        when {
            params {
                input = "tests/inputs/empty_required_field.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] Line 2 contains an empty input for required field 'cram'.")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("False pattern match") {

        when {
            params {
                input = "tests/inputs/false_pattern_match.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] The 'cram' value on line 2 does not match the pattern '^\\S+\\.cram\$'.")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Non existing File") {

        when {
            params {
                input = "tests/inputs/non_existing_file.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] The 'cram' file (assets/oops.cram) on line 2 does not exist.")
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Undetectable format") {

        when {
            params {
                input = "tests/inputs/undetectable_format.txt"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout[0] ==~ "\\[Samplesheet Error\\] Could not derive file type from .*/tests/inputs/undetectable_format.txt. Please specify the file extension."
            assert workflow.trace.succeeded().size() == 0
        }

    }

    test("Non-unique value found in unique field") {

        when {
            params {
                input = "tests/inputs/unique_error.csv"
            }
        }

        then {
            assert workflow.failed
            assert workflow.stdout.contains("[Samplesheet Error] The 'sample' value needs to be unique. 'test' was found twice in the samplesheet.")
            assert workflow.trace.succeeded().size() == 0
        }

    }

}
